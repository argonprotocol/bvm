var dt=Object.defineProperty;var ft=(U,S,_)=>S in U?dt(U,S,{enumerable:!0,configurable:!0,writable:!0,value:_}):U[S]=_;var u=(U,S,_)=>ft(U,typeof S!="symbol"?S+"":S,_);(function(){"use strict";class S{constructor(t,r,f,l,p,g,D){u(this,"bitcoinCount");u(this,"actions",[]);u(this,"shorts",[]);u(this,"shortsByDate",{});u(this,"prices",[]);u(this,"btcFees");u(this,"ratchetDec");u(this,"startingDate");u(this,"endingDate");u(this,"hodlerExpenses",0);u(this,"totalExpenses",0);u(this,"totalArgonsMinted",0);u(this,"totalCostOfArgonsToBurn",0);u(this,"totalCashUnlocked",0);u(this,"totalAccruedValue",0);u(this,"profitFromShorts",0);this.startingDate=t,this.endingDate=r,this.ratchetDec=f/100,this.shorts=l,this.shortsByDate=l.reduce(($,y)=>($[y.date==="EXIT"?"EXIT":y.date.format("YYYY-MM-DD")]=y,$),{}),this.prices=p.getDateRange(t,r),this.btcFees=g,this.bitcoinCount=D,this.run()}get totalHodlerValue(){return this.prices[this.prices.length-1].price*this.bitcoinCount-this.hodlerExpenses}get hodlerProfit(){return S.calculateProfit(this.prices[0].price*this.bitcoinCount,this.totalHodlerValue)}get startingPrice(){return this.prices[0].price}get endingPrice(){return this.prices[this.prices.length-1].price}get vaulterProfit(){const t=this.startingPrice*this.bitcoinCount,r=this.totalAccruedValue;return S.calculateProfit(t,r)}get profitFromInitialLock(){return Math.max(0,this.startingPrice+this.hodlerExpenses-this.endingPrice)*this.bitcoinCount}run(){this.actions=[];const t=this.bitcoinCount;{const r=this.prices[0].price,f=0,l=0,p=r*0,g=this.btcFees.getByDate(this.startingDate),D=this.btcFees.getByDate(this.startingDate),$=p+g+D,y=r*t-(l+$);this.hodlerExpenses=$,this.totalExpenses=$,this.totalArgonsMinted=r*t,this.totalCostOfArgonsToBurn=l*t,this.totalCashUnlocked=y,this.totalAccruedValue=y,this.actions.push({date:this.startingDate,price:r,type:"enter-vault",argonsMinted:r*t,qtyOfArgonsToBurn:f,costOfArgonsToBurn:l,securityFee:p,btcTransactionFee:g,argonTransactionFee:D,fees:$,cashChange:y,totalCashUnlocked:this.totalCashUnlocked,totalAccruedValue:this.totalAccruedValue})}for(const[r,f]of this.prices.entries()){if(r===this.prices.length-1)break;const l=f.price,p=f.date,g=this.shortsByDate[p],D=this.actions[this.actions.length-1],$=S.calculateProfit(D.price,l),y=l-D.price;if(!(this.ratchetDec&&Math.abs(y)>=this.ratchetDec&&Math.abs($)>=this.ratchetDec)&&!g)continue;const M=Math.min(l,D.price);let O=M*t,w=M*t;if(g){O=S.calculateUnlockBurnPerBitcoinDollar(g.lowestPrice)*M*t;const I=O*g.lowestPrice;this.profitFromShorts+=w-I,w=I}const k=l*0,L=$>0?this.btcFees.getByDate(p):0,q=this.btcFees.getByDate(p),H=k+L+q,j=l*t-(w+H);this.totalExpenses+=H,this.totalArgonsMinted+=l*t,this.totalCostOfArgonsToBurn+=w,this.totalCashUnlocked+=j,this.totalAccruedValue+=j,this.actions.push({date:p,price:l,type:g?"short":$>0?"ratchet-up":"ratchet-down",argonsMinted:l*t,qtyOfArgonsToBurn:O,costOfArgonsToBurn:w,securityFee:k,btcTransactionFee:L,argonTransactionFee:q,fees:H,cashChange:j,totalCashUnlocked:this.totalCashUnlocked,totalAccruedValue:this.totalAccruedValue})}{const r=this.prices[this.prices.length-1].price,f=this.actions[this.actions.length-1],l=Math.min(r,f.price);let p=l*t,g=l*t;if(this.shortsByDate.EXIT){const O=this.shortsByDate.EXIT;p=S.calculateUnlockBurnPerBitcoinDollar(O.lowestPrice)*l*t;const w=p*O.lowestPrice;this.profitFromShorts+=g-w,g=w}const D=r*0,$=this.btcFees.getByDate(this.endingDate),y=this.btcFees.getByDate(this.endingDate),v=D+$+y,M=-(g+v);this.hodlerExpenses+=v,this.totalExpenses+=v,this.totalArgonsMinted+=0,this.totalCostOfArgonsToBurn+=g,this.totalAccruedValue+=r*t+M,this.actions.push({date:this.endingDate,price:r,type:"exit-vault",argonsMinted:0,qtyOfArgonsToBurn:p,costOfArgonsToBurn:g,securityFee:D,btcTransactionFee:$,argonTransactionFee:y,fees:v,cashChange:M,totalCashUnlocked:this.totalCashUnlocked,totalAccruedValue:this.totalAccruedValue})}}static calculateUnlockBurnPerBitcoinDollar(t){const r=t,f=1;return t>=1?f:r>=.9?20*Math.pow(r,2)-38*r+19:r>=.01?(.5618*r+.3944)/r:f/r*(.576*r+.4)}static calculateProfit(t,r){return(r-t)/t}}class _{constructor(){u(this,"isLoaded",!1);u(this,"actions",[]);u(this,"prices",[]);u(this,"startingPrice",0);u(this,"endingPrice",0);u(this,"totalExpenses",0);u(this,"totalAccruedValue",0);u(this,"vaulterProfit",0);u(this,"hodlerExpenses",0);u(this,"hodlerProfit",0);u(this,"totalHodlerValue",0);u(this,"profitFromShorts",0);u(this,"profitFromInitialLock",0);u(this,"totalCashUnlocked",0);u(this,"ratchetCount",0);u(this,"shortCount",0)}update(t){this.isLoaded=!1,this.actions=t.actions,this.prices=t.prices,this.startingPrice=t.startingPrice,this.endingPrice=t.endingPrice,this.totalExpenses=t.totalExpenses,this.totalAccruedValue=t.totalAccruedValue,this.vaulterProfit=t.vaulterProfit,this.hodlerExpenses=t.hodlerExpenses,this.hodlerProfit=t.hodlerProfit,this.totalHodlerValue=t.totalHodlerValue,this.profitFromShorts=t.profitFromShorts,this.profitFromInitialLock=t.profitFromInitialLock,this.totalCashUnlocked=t.totalCashUnlocked,this.ratchetCount=t.actions.filter(r=>r.type==="ratchet-up"||r.type==="ratchet-down").length,this.shortCount=t.shorts.length}}class Q{static async fetchSimulationData(t){return await(await fetch(`/data/${t}.json`,{method:"GET",headers:{"Content-Type":"application/json"}})).json()}}var rt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function it(T){return T&&T.__esModule&&Object.prototype.hasOwnProperty.call(T,"default")?T.default:T}var K={exports:{}};(function(T,t){(function(r,f){T.exports=f()})(rt,function(){var r=1e3,f=6e4,l=36e5,p="millisecond",g="second",D="minute",$="hour",y="day",v="week",M="month",O="quarter",w="year",k="date",L="Invalid Date",q=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,H=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,j={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(o){var n=["th","st","nd","rd"],e=o%100;return"["+o+(n[(e-20)%10]||n[e]||n[0])+"]"}},I=function(o,n,e){var i=String(o);return!i||i.length>=n?o:""+Array(n+1-i.length).join(e)+o},lt={s:I,z:function(o){var n=-o.utcOffset(),e=Math.abs(n),i=Math.floor(e/60),s=e%60;return(n<=0?"+":"-")+I(i,2,"0")+":"+I(s,2,"0")},m:function o(n,e){if(n.date()<e.date())return-o(e,n);var i=12*(e.year()-n.year())+(e.month()-n.month()),s=n.clone().add(i,M),a=e-s<0,c=n.clone().add(i+(a?-1:1),M);return+(-(i+(e-s)/(a?s-c:c-s))||0)},a:function(o){return o<0?Math.ceil(o)||0:Math.floor(o)},p:function(o){return{M,y:w,w:v,d:y,D:k,h:$,m:D,s:g,ms:p,Q:O}[o]||String(o||"").toLowerCase().replace(/s$/,"")},u:function(o){return o===void 0}},W="en",x={};x[W]=j;var st="$isDayjsObject",G=function(o){return o instanceof X||!(!o||!o[st])},J=function o(n,e,i){var s;if(!n)return W;if(typeof n=="string"){var a=n.toLowerCase();x[a]&&(s=a),e&&(x[a]=e,s=a);var c=n.split("-");if(!s&&c.length>1)return o(c[0])}else{var d=n.name;x[d]=n,s=d}return!i&&s&&(W=s),s||!i&&W},b=function(o,n){if(G(o))return o.clone();var e=typeof n=="object"?n:{};return e.date=o,e.args=arguments,new X(e)},h=lt;h.l=J,h.i=G,h.w=function(o,n){return b(o,{locale:n.$L,utc:n.$u,x:n.$x,$offset:n.$offset})};var X=function(){function o(e){this.$L=J(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[st]=!0}var n=o.prototype;return n.parse=function(e){this.$d=function(i){var s=i.date,a=i.utc;if(s===null)return new Date(NaN);if(h.u(s))return new Date;if(s instanceof Date)return new Date(s);if(typeof s=="string"&&!/Z$/i.test(s)){var c=s.match(q);if(c){var d=c[2]-1||0,m=(c[7]||"0").substring(0,3);return a?new Date(Date.UTC(c[1],d,c[3]||1,c[4]||0,c[5]||0,c[6]||0,m)):new Date(c[1],d,c[3]||1,c[4]||0,c[5]||0,c[6]||0,m)}}return new Date(s)}(e),this.init()},n.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},n.$utils=function(){return h},n.isValid=function(){return this.$d.toString()!==L},n.isSame=function(e,i){var s=b(e);return this.startOf(i)<=s&&s<=this.endOf(i)},n.isAfter=function(e,i){return b(e)<this.startOf(i)},n.isBefore=function(e,i){return this.endOf(i)<b(e)},n.$g=function(e,i,s){return h.u(e)?this[i]:this.set(s,e)},n.unix=function(){return Math.floor(this.valueOf()/1e3)},n.valueOf=function(){return this.$d.getTime()},n.startOf=function(e,i){var s=this,a=!!h.u(i)||i,c=h.p(e),d=function(Y,P){var F=h.w(s.$u?Date.UTC(s.$y,P,Y):new Date(s.$y,P,Y),s);return a?F:F.endOf(y)},m=function(Y,P){return h.w(s.toDate()[Y].apply(s.toDate("s"),(a?[0,0,0,0]:[23,59,59,999]).slice(P)),s)},C=this.$W,B=this.$M,A=this.$D,V="set"+(this.$u?"UTC":"");switch(c){case w:return a?d(1,0):d(31,11);case M:return a?d(1,B):d(0,B+1);case v:var E=this.$locale().weekStart||0,N=(C<E?C+7:C)-E;return d(a?A-N:A+(6-N),B);case y:case k:return m(V+"Hours",0);case $:return m(V+"Minutes",1);case D:return m(V+"Seconds",2);case g:return m(V+"Milliseconds",3);default:return this.clone()}},n.endOf=function(e){return this.startOf(e,!1)},n.$set=function(e,i){var s,a=h.p(e),c="set"+(this.$u?"UTC":""),d=(s={},s[y]=c+"Date",s[k]=c+"Date",s[M]=c+"Month",s[w]=c+"FullYear",s[$]=c+"Hours",s[D]=c+"Minutes",s[g]=c+"Seconds",s[p]=c+"Milliseconds",s)[a],m=a===y?this.$D+(i-this.$W):i;if(a===M||a===w){var C=this.clone().set(k,1);C.$d[d](m),C.init(),this.$d=C.set(k,Math.min(this.$D,C.daysInMonth())).$d}else d&&this.$d[d](m);return this.init(),this},n.set=function(e,i){return this.clone().$set(e,i)},n.get=function(e){return this[h.p(e)]()},n.add=function(e,i){var s,a=this;e=Number(e);var c=h.p(i),d=function(B){var A=b(a);return h.w(A.date(A.date()+Math.round(B*e)),a)};if(c===M)return this.set(M,this.$M+e);if(c===w)return this.set(w,this.$y+e);if(c===y)return d(1);if(c===v)return d(7);var m=(s={},s[D]=f,s[$]=l,s[g]=r,s)[c]||1,C=this.$d.getTime()+e*m;return h.w(C,this)},n.subtract=function(e,i){return this.add(-1*e,i)},n.format=function(e){var i=this,s=this.$locale();if(!this.isValid())return s.invalidDate||L;var a=e||"YYYY-MM-DDTHH:mm:ssZ",c=h.z(this),d=this.$H,m=this.$m,C=this.$M,B=s.weekdays,A=s.months,V=s.meridiem,E=function(P,F,R,Z){return P&&(P[F]||P(i,a))||R[F].slice(0,Z)},N=function(P){return h.s(d%12||12,P,"0")},Y=V||function(P,F,R){var Z=P<12?"AM":"PM";return R?Z.toLowerCase():Z};return a.replace(H,function(P,F){return F||function(R){switch(R){case"YY":return String(i.$y).slice(-2);case"YYYY":return h.s(i.$y,4,"0");case"M":return C+1;case"MM":return h.s(C+1,2,"0");case"MMM":return E(s.monthsShort,C,A,3);case"MMMM":return E(A,C);case"D":return i.$D;case"DD":return h.s(i.$D,2,"0");case"d":return String(i.$W);case"dd":return E(s.weekdaysMin,i.$W,B,2);case"ddd":return E(s.weekdaysShort,i.$W,B,3);case"dddd":return B[i.$W];case"H":return String(d);case"HH":return h.s(d,2,"0");case"h":return N(1);case"hh":return N(2);case"a":return Y(d,m,!0);case"A":return Y(d,m,!1);case"m":return String(m);case"mm":return h.s(m,2,"0");case"s":return String(i.$s);case"ss":return h.s(i.$s,2,"0");case"SSS":return h.s(i.$ms,3,"0");case"Z":return c}return null}(P)||c.replace(":","")})},n.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},n.diff=function(e,i,s){var a,c=this,d=h.p(i),m=b(e),C=(m.utcOffset()-this.utcOffset())*f,B=this-m,A=function(){return h.m(c,m)};switch(d){case w:a=A()/12;break;case M:a=A();break;case O:a=A()/3;break;case v:a=(B-C)/6048e5;break;case y:a=(B-C)/864e5;break;case $:a=B/l;break;case D:a=B/f;break;case g:a=B/r;break;default:a=B}return s?a:h.a(a)},n.daysInMonth=function(){return this.endOf(M).$D},n.$locale=function(){return x[this.$L]},n.locale=function(e,i){if(!e)return this.$L;var s=this.clone(),a=J(e,i,!0);return a&&(s.$L=a),s},n.clone=function(){return h.w(this.$d,this)},n.toDate=function(){return new Date(this.valueOf())},n.toJSON=function(){return this.isValid()?this.toISOString():null},n.toISOString=function(){return this.$d.toISOString()},n.toString=function(){return this.$d.toUTCString()},o}(),nt=X.prototype;return b.prototype=nt,[["$ms",p],["$s",g],["$m",D],["$H",$],["$W",y],["$M",M],["$y",w],["$D",k]].forEach(function(o){nt[o[1]]=function(n){return this.$g(n,o[0],o[1])}}),b.extend=function(o,n){return o.$i||(o(n,X,b),o.$i=!0),b},b.locale=J,b.isDayjs=G,b.unix=function(o){return b(1e3*o)},b.en=x[W],b.Ls=x,b.p={},b})})(K);var ot=K.exports,tt=it(ot);class at{constructor(){u(this,"prices",[]);u(this,"indexByDate",{})}load(t){this.prices=t.map((r,f)=>(this.indexByDate[r.date]=f,{date:r.date,price:Number(r.price)}))}get all(){return this.prices.map(t=>({date:t.date,price:t.price}))}getForYear(t){return this.prices.filter(r=>r.date.startsWith(t))}getDateRange(t,r){const f=this.indexByDate[t],l=this.indexByDate[r];return this.prices.slice(f,l+1)}getByIndex(t){return this.prices[t]}getByDate(t){return t instanceof tt&&(t=t.format("YYYY-MM-DD")),this.prices.find(r=>r.date===t)??{date:"",price:0}}}class ct{constructor(t){u(this,"feeByDate",{});u(this,"btcPrices");this.btcPrices=t}load(t){this.feeByDate=Object.fromEntries(t.map(r=>[r.date,Number(r.feeInBitcoins)]))}getInBitcoins(t){return this.feeByDate[t]}getByDate(t){const r=this.getInBitcoins(t);if(!r){const p=tt.utc(t).subtract(1,"day");if(p.isBefore("2010-07-18"))throw new Error("Date is before 2010-07-18");return this.getByDate(p.format("YYYY-MM-DD"))}const f=this.btcPrices.getByDate(t).price;return r*f}}const z=new at,et=new ct(z),ut=ht();async function ht(){const[T,t]=await Promise.all([Q.fetchSimulationData("bitcoinPrices"),Q.fetchSimulationData("bitcoinFeesPerTransaction")]);z.load(T),et.load(t)}self.addEventListener("message",async T=>{await ut;const{startingDate:t,endingDate:r,ratchetPct:f,shorts:l,bitcoinCount:p}=T.data,g=new S(t,r,f,l,z,et,p),D=new _;D.update(g),self.postMessage(D)})})();
